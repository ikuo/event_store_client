version: "3.7"

## Note: Before running `docker-compose up -d`
## make sure that certs are generated by runnning ./create-certs.sh

volumes:
  postgres-data:
  eventstore-volume-data:
  eventstore-volume-logs:
  esc-sync:
    external: true
services:
  eventstore.db:
    image: eventstore/eventstore:20.6.1-buster-slim
    ## container_name needs to match the DNS name in certificate
    container_name: eventstoredb
    environment:
      - EVENTSTORE_CLUSTER_SIZE=1
      - EVENTSTORE_RUN_PROJECTIONS=All
      - EVENTSTORE_START_STANDARD_PROJECTIONS=true
      - EVENTSTORE_ENABLE_EXTERNAL_TCP=true
      - EVENTSTORE_ENABLE_ATOM_PUB_OVER_HTTP=true
      - EVENTSTORE_EXT_TCP_PORT=1113
      - EVENTSTORE_EXT_HTTP_PORT=2113
      - EVENTSTORE_CERTIFICATE_FILE=/etc/eventstore/certs/node/node.crt
      - EVENTSTORE_CERTIFICATE_PRIVATE_KEY_FILE=/etc/eventstore/certs/node/node.key
      - EVENTSTORE_TRUSTED_ROOT_CERTIFICATES_PATH=/etc/eventstore/certs/ca
    ports:
      - 1113:1113
      - 1114:1114
      - 2113:2113
      - 2114:2114
    networks:
      - esdb_network
    volumes:
      - ./certs:/etc/eventstore/certs
      - type: volume
        source: eventstore-volume-data
        target: /var/lib/eventstore
      - type: volume
        source: eventstore-volume-logs
        target: /var/log/eventstore
    restart: unless-stopped

  dev:
    image: yousty/esc:test
    command: tail -f /dev/null
    networks:
      - esdb_network
    volumes:
      - /usr/src/app/tmp
      - esc-sync:/usr/src/app:nocopy
      - /dev/shm:/dev/shm
    depends_on:
      - eventstore.db
    env_file:
      - .env

networks:
  esdb_network:
